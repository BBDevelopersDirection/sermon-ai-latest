# Feature Plan 0003: 7-Day Free Trial Implementation

## **Brief Description**

Implement a 7-day grace period system for new users where subscriptions are created immediately but payment is processed after 7 days. The trial period will be managed entirely through the Utility collection in Firestore, while reading subscription data from the Subscription collection to determine trial start/end times. Users in trial period will have unlimited access to content, and after trial expiration, if payment fails or subscription status is not `active`/`payment_captured`, they will be shown the recharge page with the same subscription ID.

## **Current System Analysis**

### **Existing Subscription Flow**
1. User attempts to access content beyond free limit (2 reels)
2. System checks for existing subscription ID in Users collection
3. If no subscription exists, creates customer via `/create-customer` endpoint
4. Creates subscription via `/create-subscription` endpoint with `startDate: 7` (7-day grace period)
5. Stores subscription ID in Users collection
6. Opens Razorpay payment page
7. Listens to Subscription collection for status changes
8. On `subscription_authenticated` status, grants unlimited access
9. **NEW**: During 7-day grace period, status remains `subscription_authenticated` and user has unlimited access
10. **NEW**: After 7 days, if, status are not `active` or `payment_captured` user should see recharge page.

### **Subscription Collection Data Structure**
- `createdAt`: Subscription ID creation time
- `currentStart`: Grace period end time and real subscription start time (7 days after createdAt)
- `currentEnd`: Subscription end date (usually 1 year after currentStart)
- `status`: `subscription_authenticated` during grace period, `active`/`payment_captured` after successful payment after 7 days.

## **Technical Implementation**

### **Phase 1: Utility Collection Enhancement**

#### **Files to Modify:**
- `lib/services/firebase/firestore_variables.dart`
- `lib/services/firebase/models/utility_model.dart`

#### **New Fields in Utility Collection:**
```dart
// Add to FirestoreVariables
static const String isFreeTrialActive = 'IS_FREE_TRIAL_ACTIVE';
static const String freeTrialStartDate = 'FREE_TRIAL_START_DATE';
static const String freeTrialEndDate = 'FREE_TRIAL_END_DATE';
static const String subscriptionId = 'SUBSCRIPTION_ID';
```

#### **Enhanced UtilityModel:**
```dart
class UtilityModel {
  final String userId;
  final int totalVideoCount;
  final bool isRecharged;
  final int videoCountToCheckSub;
  final DateTime? rechargeStartDate;
  final DateTime? rechargeEndDate;
  
  // New trial fields
  final bool isFreeTrialActive;
  final DateTime? freeTrialStartDate;
  final DateTime? freeTrialEndDate;
  final String? subscriptionId;
}
```

### **Phase 2: Trial Logic Implementation**

#### **Files to Modify:**
- `lib/services/firebase/utils_management/utils_functions.dart`
- `lib/services/firebase/subscription_management/subscription_function.dart`

#### **New Functions in UtilsFunctions:**

1. **Grace Period Status Check:**
```dart
Future<bool> isWithinGracePeriod() async {
  // Get user utility data
  // Check if grace period is active and not expired
  // Use network time for accurate validation
  // Check subscription status is 'subscription_authenticated'
}
```

2. **Grace Period Initialization:**
```dart
Future<void> initializeGracePeriod({
  required String subscriptionId,
  required DateTime graceStartDate,
  required DateTime graceEndDate,
}) async {
  // Set grace period fields in Utility collection
  // Mark grace period as active
  // Store subscription ID for later use
}
```

3. **Grace Period Expiration Check:**
```dart
Future<void> checkGracePeriodExpiration() async {
  // Check if grace period has expired
  // Check if subscription status is still 'subscription_authenticated'
  // If expired and not paid, show recharge page with same subscription ID
  // Update grace period status in Utility collection
}
```

4. **Enhanced Access Control:**
```dart
Future<bool> canUseReel({required int index}) async {
  // Check if user has active subscription (isRecharged = true)
  // Check if user is within grace period (subscription_authenticated + within 7 days)
  // Check if user is within free limit (2 reels)
  // Return appropriate access level
}

Future<bool> canUseVideo() async {
  // Similar logic for video access
  // Consider grace period in validation
}
```

#### **Enhanced Subscription Functions:**

1. **Grace Period Status from Subscription:**
```dart
Future<GracePeriodStatus> getGracePeriodStatusFromSubscription({
  required String subscriptionId,
}) async {
  // Read from Subscription collection
  // Determine grace period based on createdAt, currentStart
  // Check if status is 'subscription_authenticated'
  // Return grace period status (active, expired, not_started, paid)
}
```

### **Phase 3: Subscription Flow Integration**

#### **Files to Modify:**
- `lib/services/plan_service/plan_purchase_cubit.dart`
- `lib/reusable/payment_in_progress_page.dart`

#### **Enhanced Plan Purchase Flow:**

1. **Grace Period-Aware Subscription Creation:**
```dart
Future<void> rechargeNowCallBack({required BuildContext context}) async {
  // Check if user is in grace period
  // If in grace period, show grace period expiration message
  // If grace period expired and not paid, show recharge page with same subscription ID
  // Initialize grace period data when subscription is created
}
```

2. **Grace Period Status Monitoring:**
```dart
// In PaymentInProgressPage
void _startListening() {
  // Listen to subscription status changes
  // When status becomes 'subscription_authenticated', initialize grace period
  // When status becomes 'active'/'payment_captured', end grace period and set isRecharged = true
}
```

### **Phase 4: Application Startup Integration**

#### **Files to Modify:**
- `lib/services/token_check_service/login_check_cubit.dart`

#### **Enhanced Startup Logic:**
```dart
Future<void> checkPlanExpire() async {
  // Check subscription expiration
  // Check grace period expiration
  // If grace period expired and subscription status is still 'subscription_authenticated', show recharge page
  // Update utility data accordingly
  // Set appropriate access levels
}
```

### **Phase 5: UI Integration**

#### **Files to Modify:**
- `lib/screens/after_login/bottom_nav/bottom_nav_zero/bottom_nav_zero_screen.dart`
- `lib/reusable/recharge_page.dart`

#### **Grace Period-Aware UI:**
1. **Grace Period Status Display:**
   - Show grace period remaining days
   - Display grace period expiration warning
   - Update paywall messaging for grace period users

2. **Enhanced Paywall:**
   - Different messaging for grace period vs non-grace period users
   - Grace period countdown display
   - Clear subscription benefits
   - Show recharge page with same subscription ID if grace period expired

## **Algorithm Implementation**

### **Grace Period Calculation:**
```dart
// Grace period logic
DateTime graceStart = subscription.createdAt;
DateTime graceEnd = subscription.currentStart; // 7 days after creation
DateTime now = await getNetworkTime() ?? DateTime.now();

bool isGracePeriodActive = now.isAfter(graceStart) && now.isBefore(graceEnd);
bool isGracePeriodExpired = now.isAfter(graceEnd);
bool isSubscriptionPaid = subscription.status == 'active' || subscription.status == 'payment_captured';
```

### **Access Control Logic:**
```dart
Future<bool> hasAccess() async {
  // 1. Check if user has active subscription (isRecharged = true)
  if (utility.isRecharged) return true;
  
  // 2. Check if user is within grace period and subscription is authenticated
  if (utility.isGracePeriodActive && 
      now.isBefore(utility.gracePeriodEndDate) &&
      subscription.status == 'subscription_authenticated') {
    return true;
  }
  
  // 3. Check if user is within free limit (2 reels)
  if (index < FirestoreVariables.totalReelCountUserCanSee) {
    return true;
  }
  
  return false;
}
```

### **Grace Period State Management:**
```dart
// Grace period states
enum GracePeriodStatus {
  notStarted,     // No subscription created
  active,         // Within 7-day grace period, subscription_authenticated
  expired,        // Grace period ended, payment failed, still subscription_authenticated
  paid,           // Grace period ended, payment successful, active/payment_captured
}
```

## **Data Flow**

### **Grace Period Initialization:**
1. User triggers subscription flow
2. Create customer and subscription via API
3. Subscription created with `startDate: 7`
4. Listen to subscription status changes
5. When status becomes `subscription_authenticated`:
   - Set `isGracePeriodActive: true` in Utility collection
   - Set `gracePeriodStartDate: createdAt` from subscription
   - Set `gracePeriodEndDate: currentStart` from subscription
   - Set `subscriptionId` in Utility collection

### **Grace Period Monitoring:**
1. On app startup, check grace period status
2. Compare current time with `gracePeriodEndDate`
3. Check subscription status in Subscription collection
4. If grace period expired and status is still `subscription_authenticated`:
   - Set `isGracePeriodActive: false` in Utility collection
   - Show recharge page with same subscription ID
5. Update access control accordingly

### **Grace Period Conversion:**
1. User's payment is processed after 7 days (automatic)
2. Subscription status changes to `active`/`payment_captured`
3. Set `isRecharged: true` in Utility collection
4. Set `isGracePeriodActive: false`
5. Set subscription dates for paid period

## **Error Handling**

### **Network Time Sync:**
- Use `MyAppEndpoints.instance().getNetworkTime()` for accurate time
- Fallback to local time if network time unavailable
- Log time sync failures for debugging

### **Subscription Data Inconsistency:**
- Handle missing subscription data gracefully
- Provide fallback to free tier access
- Log data inconsistencies for monitoring

### **Grace Period State Corruption:**
- Validate grace period data on app startup
- Reset corrupted grace period states
- Ensure consistent access control

## **Testing Considerations**

### **Grace Period Testing:**
- Test grace period initialization with different subscription statuses
- Test grace period expiration logic with various time scenarios
- Test grace period conversion to paid subscription
- Test recharge page display when grace period expires and payment fails

### **Access Control Testing:**
- Verify unlimited access during grace period
- Verify limited access after grace period expiration
- Test edge cases around grace period start/end times
- Test recharge page with same subscription ID when grace period expires

### **Data Consistency Testing:**
- Test utility collection updates
- Verify subscription collection reads
- Test offline/online data synchronization

## **Performance Considerations**

### **Efficient Data Access:**
- Cache trial status in memory during app session
- Minimize Firestore reads for trial status checks
- Use batch operations for utility collection updates

### **Real-time Updates:**
- Listen to subscription status changes efficiently
- Update trial status reactively
- Minimize unnecessary UI rebuilds

## **Security Considerations**

### **Time Validation:**
- Always use server time for grace period calculations
- Prevent client-side time manipulation
- Validate grace periods server-side when possible

### **Access Control:**
- Implement server-side validation for critical operations
- Use Firestore security rules for data protection
- Log suspicious access patterns

This implementation ensures that the 7-day grace period is managed entirely through the Utility collection while leveraging subscription data for accurate grace period calculation, maintaining the existing subscription flow and adding comprehensive grace period management capabilities. The system automatically processes payment after 7 days, and if payment fails, users are shown the recharge page with the same subscription ID for retry.
